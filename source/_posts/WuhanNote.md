---
title: 计算机体系结构note
date: 2021-07-05 09:06:13
tag:
- 计算机体系结构
categories:
- 2021
- Summer
- 计算机体系结构
password: password
top: 50
---

# Summer Intern 21年6-8月
# 计算机体系结构

## 国防科大公开课
[计算机体系结构国防科大35讲](https://www.bilibili.com/video/BV1aJ411g7LM?p=2)
1. ### 概念
    1. 冯诺依曼结构
    2. 20世纪80年代以来：RISC（精简指令集计算机）--指令集并行（流水线；多指令发射）；缓存
        - 20世纪80年代出现了个人计算机和工作站，因为有微处理器可供使用
        - 80年代初RISC出现 --简化了指令系统，把更多的芯片硅面积用于实现`流水`和`cache`
        - 20世纪80年代，单片芯片上集成到25000-50000个晶体管
    3. ISA（Instruction Set Architecture指令集体系结构）：区分软硬件的界限
        - 80x86
            1. 16个通用寄存器，16个存入浮点数据的寄存器
            2. `寄存器-存储器`ISA：在许多指令中，访问存储器
            3. 编码为可变长度，变化长度为1--18个`字节` -- 可变长度的指令可以占用较少的空间
        - ARM
            1. `载入-存储`ISA（只能用load/store来访问存储器，所有最新的ISA都采用载入-存储ISA）
            2. 所有ARM和MIPS指令都是的长度都是32位
        - MIPS
            1. 32个通用寄存器，32个浮点寄存器
            2. `载入-存储`ISA（只能用load/store来访问存储器）
    4. intel和ARM（都是ISA）  （CISC和RISC）
        - [知乎一篇文章](https://zhuanlan.zhihu.com/p/21266987)
        - ARM和Intel 两种架构，X86无法做到ARM的功耗，而ARM也无法做到X86的性能
        - ARM从来只是设计`低功耗处理器`，Intel的强项是设计`超高性能`的台式机和服务器处理器。
        - Intel i7处理器平均发热功率为45w，ARM是1/15
        - 制造工艺的纳米数越小，能量的使用效率越高
        - ARM的big.LITTLE架构是一项Intel一时无法复制的创新 --处理器中的核可以有不同的性能和功耗
        - 前端设计体现了处理器的构架，精简指令集和复杂指令集的区别是通过前端设计体现的
        - 后端设计处理电压，时钟等问题，是耗电的直接因素。
        - 移动处理器都是片上系统(SoC)架构，也就是说，处理器之外，图形，视频，音频，网络等功能都在一个芯片里。这些模块的打开与关闭就容易预测的多，并且可以通过软件来控制。这样，整体功耗就更加取决于软件和制造工艺而不是处理机架构。在这点上，X86的处理器占优势，因为Intel的工艺有很大优势
        - `疑惑`：
            1. ARM处理器的乱序执行能力不如intel--intel加入乱序逻辑结构，因为ARM是异构，就没有这方面的问题（一个核顺序执行，一个核乱序执行）
    5. 存储器寻址与寻址模式
        1. 字节寻址 ： 对齐
        2. `寻址模式`：
            1. MIPS寻址模式：
                - 寄存器寻址
                - 立即数寻址
                - 位移量寻址 ：讲固定偏移量加到寄存器得出存储器地址
            2. 80x86 ：
                - 寄存器
                - 立即数
                - 位移量 ： 分三种。。。
            3. ARM ：
                - 寄存器
                - 立即数
                - 位移量
                - PC（程序计数器）的寻址方式
                - 两个寄存器之和
                - 自动递增寻址/自动递减寻址

    6.宽带和吞吐量：在给定时间内完成的总工作量
    7. 集成电路中的功率和能耗：
        1. 功率：单位时间的能耗
        2. 能耗 与 该晶体管驱动的容性负载与电压平方的乘积成正比
        3. 缩减元件之间的间距之后，晶体管之间的电容也会降低，晶体管的开关频率也得以提升，从而整个芯片的工作频率就上去了。
        4. 晶体管的尺寸缩小会减低它们的内阻，所需导通电压会降低，这代表着CPU的工作电压会降低
        5. 动态随机存取存储器（Dynamic Random Access Memory，DRAM）是一种半导体存储器，主要的作用原理是利用电容内存储电荷的多寡来代表一个二进制比特（bit）是1还是0。由于在现实中晶体管会有漏电电流的现象，导致电容上所存储的电荷数量并不足以正确的判别数据，而导致数据毁损。因此对于DRAM来说，周期性地充电是一个无可避免的要件。由于这种需要定时刷新的特性，因此被称为“动态”存储器。相对来说，静态存储器（SRAM）只要存入数据后，纵使不刷新也不会丢失记忆。
    8. 可信任度：
        1. 模块可靠性：对发生故障之前的时间度量 MTTF MTTR
    9. `时钟周期`是计算机中最基本的、最小的时间单位。 在一个时钟周期内，CPU仅完成一个最基本的动作。 时钟周期是一个时间的量。
        - 1993年的奔腾支持超流水线，一个时钟周期可以执行两条整数运算命令
        - 现在的时钟周期有的是`0.几ns`；

    10. CPU到内存时间还是不够快，有时候要几百个时钟周期。所以内存和cpu之间还有2--3级`缓存`




<div  align="center">
    <img src="../图片/计算机体系结构/程序执行和指令的操作.png" width = "300" height = "200" alt="bpp" align=center />
    </div>
    程序执行的过程 --控制流 数据流
    <div  align="center">
    <img src="../图片/计算机体系结构/计算机的属性.png" width = "300" height = "200" alt="bpp" align=center />
    </div>
    程序员能看到的计算机的属性
    <div  align="center">
    <img src="../图片/计算机体系结构/指令集结构的逻辑实现.png" width = "300" height = "200" alt="bpp" align=center />
    </div>
    指令集结构的逻辑实现


    20. 系列机和兼容
        1. family machine：具有相同体系机构，但组成和实现不同
        2. 软件兼容software compatibility ： 同一个软件-不加修改-获得相同结果（兼容种类也可以细分为二进制级兼容，汇编级兼容等）
        3. 兼容机：支持软件兼容的硬件基础
        4. 兼容性（向下向上：高低档机器先前向后：不同时期投入市场）   --兼容性up 寿命up
            向后兼容：软件兼容的根本特征
2. ### 发展
    1. 计算机的分代（从91年以后是第五代：高性能微处理器+大规模高密度电路）
    2. 软件的发展：
    3. 处理器性能的提高，从单纯依赖指令集并行（ILP）转向数据级并行（DLP）和线程级并行（TLP）
        - 指令 和 线程
        - 数据级并行DLP：同时操作许多数据项
        - 任务/线程级并行：？？？
        - 戴老师讲：数据级并行其实就是许多人用用一个指令处理一堆不同的数据
    5. 计算机的分类：
        1. 个人移动设备PMD（手机平板）
        2. 台式机
        3. 服务器：
                - 可用性 ： 要不间断的能使用，安全
                - 可拓展性 ： 满足对功能的增长需求 ， 拓展计算容量，内存，I/O带宽
        4. 仓库级计算机（WSC）
        5. 嵌入式：能否运行第三方软件
        根据并行分：
            1. SISD
            2. SIMD：数据级并行，同一指令由多个使用不同数据流的处理器执行
            3. MISD
            4. MIMD：多指令 多数据  --针对的是任务级并行
    3. 应用的发展：
        - 桌面计算：笔记本，工作站...（竞争激烈的市场）
        - 服务器计算：可靠性做为追求目标
        - 嵌入式计算：打印机，物联网...
    4. 体系结构的发展：对结构的不断改良
        - 分布的IO处理能力：IO装置具有独立的处理能力：打印机，把游戏指令发给显卡后显卡会主动生成怪物      ----有效减轻cpu处理负荷
        - 保护的存储器空间：数据和程序严格割裂开，有利于程序的保护和发展
        - 存储器组织结构的发展
        - `并行处理技术`
        - 指令集发展：用户可以定义自己的指令系统 效率up
    5. 并行处理技术的发展
        1. 并行性概念：
            1. **`指令级并行`**
                1. 2002年以来，性能增长下降约20% ---> 可以进一步有效开发的指令级并行已经很少  --->04年，从单纯依靠指令级并行转向线程级并行和数据级并行
            2. `线程级并行`
        2. 提高并行性的技术途径 ：时间重叠（用流水线，同时处理多个指令，每个指令都可以处于不同的阶段），资源重复（一个cpu不够用多个，数量取胜原则），资源共享（提高资源的利用效率，多个人使用一个打印机）
        3. 并行计算的应用需求：对计算机的长远需求：工业设计 大气污染 天气预报等等
    6. 计算机系统的成本和价格
    7. 思考一些问题： 软件兼容的例子；列举操作系统为上层应用提供的典型API有哪些，功能是什么
    8. 集成电路的发展和`摩尔定律`：“集成电路密度大概每两年翻一番---摩尔定律”  摩尔定律，也就是说，当价格保持不变时，集成电路上可容纳的晶体管数量每18个月增加一倍，性能提高一倍
| 时间               | 生产工艺 | cpu晶体管数量    |
| ------------------ | -------- | ---------------- |
| 2000 奔腾4威拉米特 | 180nm    | 4200万           |
| 2010  Corei7≤980X  | 32nm     | 11亿6999万9999个 |
| 2013核心i7 4960X  |  22nm | 18.6亿|

3. ### 计算机系统设计和分析
    1. 成本与价格 ：晶圆晶片制造，测试成本，封装。。。
    2. 基准测试程序： [测试程序包](www.SPEC.org)
    3. 量化设计的基本原则
        1. 大概率事件优先原则：追求全局的最优结果
            - 赋予优先处理权和资源使用权
        2. Amdahl定律：通过对系统加速比的研究，来找到系统中占有最重要的部件（可以定量计算）
            - 假设对机器部件的改进，来计算加速比
            -   如下：
                <div  align="center">
                <img src="../图片/计算机体系结构/amdahl定律1.png" width = "400" height = "200" alt="bpp" align=center />
                </div>
                系统加速比的公式
                系统加速比依赖于两个因素：可改进比例，部件加速比
            - 性能增加的递减规则：针对改进的某一部分，改进越多，效果越小
            - 公式的引申和推论：
                - 对于整个任务的一部分进行优化，则`最大加速比`不大于1/(1-可改进比例)

        3. Amdahl定律的计算练习
        3. 程序的`局部性`原理：程序执行时所访问的存储器在`时空`上是相对的簇聚（这种簇聚包括指令和数据两部分）: 时间局部性 空间局部性 生产-消费局部性

4. ### 指令系统
    1. 指令集结构概述
        1. 每条指令都是直接由cpu硬件执行
            CPU插播：进入工厂的原料(程序指令)，经过物资分配部门(控制单元)的调度分配，被送往生产线(逻辑运算单元)，生产出成品(处理后的数据)后，再存储在仓库(储存单元)中，最后等着拿到市场上去卖(交由应用程序使用)
        2. 指令的表示：二进制格式...
        3. 指令的操作非常简单，其操作由操作码编码表示，每个操作需要的操作数个数为0-3个不等   --操作数是一些`存储单元`的地址(典型的存储单元：主存，寄存器，堆栈和累加器)
        4. `指令集与计算机的性能` T
            - 指令集在程序中：软硬件的接口
    2. 指令集结构的分类：
        - 在cpu中`操作数`的存储方法
        -  <div  align="center">
            <img src="../图片/计算机体系结构/指令集结构的分类.png" width = "300" height = "200" alt="指令集结构的分类" align=center />
            </div>
            几种分类（堆栈；累加器等）
        - <div  align="center">
            <img src="../图片/计算机体系结构/通用寄存器型指令集结构的分类.png" width = "300" height = "200" alt="通用寄存器型指令集结构" align=center />
            </div>
             通用寄存器型指令集结构的分类  -------？
        - 由此， 三种通用寄存器型指令集结构的优缺点: 寄存器-寄存器（0，3）；寄存器-存储器型（1，2）；存储器-存储器型（3，3）
        - <div  align="center">
            <img src="../图片/计算机体系结构/指令集结构设计概观.png" width = "300" height = "200" alt="指令集结构设计概观" align=center />
            </div>
            指令集结构设计概观
    3. 存储器寻址：几乎所有都使用`字节寻址`来访问存储器操作数
        - ARM+MIPS要求操作对象必须是对齐的
    4. 存储器寻址与寻址模式
        1. 字节寻址 ： 对齐
        2. `寻址模式`：
            1. MIPS寻址模式：
                - 寄存器寻址
                - 立即数寻址
                - 位移量寻址 ：讲固定偏移量加到寄存器得出存储器地址
            2. 80x86 ：
                - 寄存器
                - 立即数
                - 位移量 ： 分三种。。。
            3. ARM ：
                - 寄存器
                - 立即数
                - 位移量
                - PC（程序计数器）的寻址方式
                - 两个寄存器之和
                - 自动递增寻址/自动递减寻址

    3. 寻址方式：寄存器寻址；立即值寻址；偏移寻址；寄存器间接寻址（没有偏移量，值得注意的是：`(R1)`表示的是以R1的`地址`为内容的）；索引寻址（一般可用于对数组的访问）；直接寻址或绝对寻址；存储器间接寻址；自增/减寻址；缩放寻址
        - e.g.` Add R1, (1001)` ---这属于直接寻址，1001是地址， 这条指令的含义就为：`Regs[R1]<-Regs[R1]+Mem[1001]`，这里的Mem[1001]就是地址为1001的寄存器里的内容。变量Mem用来表示存储器中的一个数组，存储按照字节寻址，它可以传送任何数目的字节。
        - e.g. `Add R1,@(R3)` ---存储器间接寻址，含义为：`Reg[R1]<-Regs[R1]+Mem[Mem[Regs[R3]]]`首先访问寄存器，取出一个存储单元的地址，再访问该存储单元，取出保存操作数的那个存储单元的地址，再通过一次访存，得到操作数。   （只是加深理解，基本不会使用）
    4. MIPS的指令格式：
    <div  align="center">
    <img src="../图片/计算机体系结构/MIPS指令格式.png" width = "450" height = "200" alt="MIPS指令格式" align=center />
    </div>

    [MIPS指令基本格式一篇文章](http://www.yuejianzun.xyz/2018/02/18/MIPS指令集与简单分析/)

    4. 指令系统的设计和优化
        1. 引入控制指令概念：Jump（跳转），Branch
        2. 过程调用和返回的状态保存（调用者保存 被调用者保存--一般用它）
    5. 指令系统的发展和改进
        - 强化指令功能，软件功能向硬件功能转移（CISC）
        - RISC：在向着它发展
    6. 操作数的类型和大小
    7. MIPS指令系统结构
        1. 操作数保存在寄存器里，所以只能通过load/store指令来访问存储器
        2. MIPS是一种多元指令结构，注重指令流水效率
        3. 有32个32位的通用寄存器，R0的内容恒为0；32个32位浮点寄存器
        4. 支持：寄存器寻址，立即值寻址，偏移寻址，寄存器间接寻址。
        5. 操作类型：<-,##,

5. ### 流水线技术
    1. #### 流水线基本概念  ：硬件资源降到最低程度
        1. 指令流水线
        2. 功能部件流水线
        3. 用时空图来描述：横时间，纵各流水线
        4. 特点：
            1. 级/段；深度
        5. 流水线的分类：
            1. （按流水线 完成的 功能 分类）
                1. 单功能流水线 ： 只能完成一种固定功能的流水线
                2. 多功能流水线 ： 各段进行不同的连接，例如：TI ASC
            2. 按连接方式
                1. 静态流水线 ：TI ASC
                2. 动态流水线 ： 重叠在一起，可能会冲突
            3. 按级别
                1. 部件级进行流水
                2. 指令流水线
                3. 处理机间流水线--宏流水线
            4. 按数据表示
                1. 标量流水处理机 ： 仅对标量进行数据处理
                2. 向量流水处理机 ： 例如TI ASC
            5. 是否有反馈回路
                1. 线性流水线
                2. 非线性 ： 有可能在汇集点冲突 ---流水线调度问题
    2. #### MIPS基本流水线：
        1. 非流水方式
        2. 划分为5个阶段：
            1. 取指令（IF）：
                - 根据PC值从存储器取出指令，并将指令送入指令寄存器IR；PC++（指向下一条指令）；并将下一条指令的的地址放入临时寄存器NPC中   ---ps：指令的地址就是pc的值吗
            2. 译码/读寄存器（ID）：
                - 进行指令译码，读IR寄存器（指令寄存器），按照相应寄存器号读寄存器文件，...
            3. 执行/有效地址计算周期（EX）：
                - ，
            4. 访存/分支操作完成周期（MEM）
            5. 写回周期（WB）
            6. 性能分析
                7. ？？？？？
    3. 流水线中的相关
        1. 流水线性能分析
            三项性能指标：吞吐率；最大吞吐率；实际吞吐率
                - 吞吐率是指单位时间内流水线所完成的任务数或输出结果的数量
                - 最大吞吐率：流水线达到稳定状态后所得到的吞吐率
                    瓶颈 ---细分瓶颈段，重复设置瓶颈段（并列的）
                    有一个吞吐率的计算 题型
                - 假设流水线各段的时间相等
        2. 加速比： 流水线速度：等功能非流水线速度
        3. 效率：流水线的设备利用率
            1. 从时空图上看，时空区面积之比
            2. 效率是：实际加速比与最大加速比之比
        4. 锁存器 ： 对时钟扭曲不敏感
        5. 什么是相关？ --相邻/近的两条指令因存在某种关联，后一条指令不能在原先指定的时钟周期开始执行
        6. 消除相关的基本方法：暂停（低效）
        7. 三种不同类型的相关：
            - 结构相关：硬件资源满足不了重叠执行的要求
                原因：
                    - 功能部件不是全流水
                    - 重复设置的资源数量不足
                避免：
                    - 所有功能单元完全流水化
                    - 设置足够多的硬件资源 （硬件代价很大）
            - 数据相关：要用到前面指令的结果
                1. 定向技术forwarding（可以减少数据相关带来的暂停），也称为旁路（bypassing）：
            - 控制相关：遇到分支指令/改变pc值的指令
    4. 实例分析：MIPS R4000
    5. 向量处理机


## 数据结构与算法
1. ### GPU


## extra
1. IPv4地址由32位二进制数组成，即地址字节数为4 xxx.xxx.xxx.xxx (xxx是小于255的十进制数，换算成2进制就是小于8位)
    - 将地址长度扩大至 IPv4 地址的 4 倍， 即由 32bit 扩展至128bit ，即16个地址字节数
    - 为互联网上的每一个网络和每一台主机分配一个逻辑地址
    - MAC（Media Access Control或者Medium Access Control）地址，意译为媒体访问控制，或称为物理地址、硬件地址，用来定义网络设备的位置
    - 存储器地址（Memory address）是存储器中存储单元的编号。 --32位操作系统存储器地址字节为4个字节，64位操作系统存储器地址字节为8个字节
        - 一个字节（byte）就是8bit
        - **1kb是1024byte**，1024*8位数字
2. 半导体：关系到CPU内能塞进多少个晶体管，CPU所能达到的频率还有它的功耗
    1. ss

| 1978年              | 3000nm生产工艺 | 29000个晶体      | 工作频率5MHz            |
| ------------------- | -------------- | ---------------- | ----------------------- |
| 28核Skylake-SP Xeon | 14nm生产工艺   | 超过80亿个晶体管 | 5GHz（Core i9-9900K）｜
    我们所说的生产工艺是指
    线宽，也就是芯片上的最基本功能单位门电路的宽度，因为实际上门电路之间连线的宽度同门电路的宽度相同，所以线宽可以描述制造工艺
    制造工艺用特征尺寸来衡量，即一个晶体管或一条连线在x/y的最小尺寸
3. 晶圆 晶片 集成电路 芯片 核 cpu 主板 内存 等等的关系：
    1. 硅晶圆尺寸越大越好，因为这样每块晶圆能生产更多的芯片。
        - 无法随心所欲地增大晶圆尺寸： 生产过程中，离晶圆中心越远就越容易出现坏点
        - 晶体管在处理器上集成，晶体管与晶体管之间用金属线路连接（金属线路的容量直接影响信息传送的速度）
    2. 了解cpu的制作流程 ：
        1. 切割晶圆 ： 用机器从单晶硅棒上切割下一片事先确定规格的硅晶片，并将其划分成多个细小的区域，每个区域都将成为一个CPU的内核（Die）
        2. 紫外线通过`印制着CPU复杂电路结构图样`的模板照射硅基片，被紫外线照射的地方光阻物质溶解
        3. 下一步就是蚀刻（etching）：结合上面制造的基片，CPU的门电路就完成了
        4. 重复；分层：3d结构，7--9层，层数决定于设计时CPU的布局，以及通过的电流大小
        5. 封装：封入一个陶瓷的或塑料的封壳中，这样它就可以很容易地装在一块电路板上
    3. 芯片是半导体元件产品的统称，是集成电路的载体，由晶圆分割而成。
        - 集成电路包括半导体芯片及外围相关电路（电阻电容二极管）
        - 芯片是“集成电路”的俗称。集成电路有模拟集成电路和数字集成电路，如果一片集成电路（芯片）中既有模拟电路又有数字电路，则称其为数模混合集成电路
        - CPU是中央处理器，包含运算器和控制器，是数字电路。如果将运算器和控制器集成在一片集成电路上，就称之为微处理器。目前人们将中央处理器与微处理器已经混为一谈了
        - so，CPU是一种数字芯片，只是众多芯片中的一类
        - 一块晶圆上可以切割出数百个处理器(晶体管：50-200nm尺寸)
    4. 晶体管相当于开关，控制着电流的方向（一个针头上就能放下大约3000万个晶体管）。
4. 线程进程程序：
    1. 一个程序包含着若干个进程，一个进程包含着若干个线程。


10. <kbd>这是什么</kbd>
<table>
    <tr>
        <th rowspan="2">真实情况</th>
        <th colspan="2">预测结果</th>
    </tr>
    <tr>
        <td>正例</td>
        <td>反例</td>
    </tr>
    <tr>
        <td>正例</td>
        <td>TP(真正例)</td>
        <td>FN(假反例)</td>
    </tr>
    <tr>
        <td>反例</td>
        <td>FP(假正例)</td>
        <td>TN(真反例)</td>
    </tr>
</table>


## 疑问疑难
1. Mem\[\]和Regs\[\]的理解：Mem的方括号里是表示地址的一串数字，Mem\[\]表达的是内容       ----所以表示地址的和表示内容的其实是长度相同的一串二进制数字吗？？？       Regs\[\]表示的是数值
2.  (7.1早上，周四) 数据级并行，指令集并行，任务级并行，线程级并行；SIMD，MIMD等。深入梳理
3.  核 整理 core multi-core
4.  各种频率的理解
    1. 手机 cpu频率2.xGHz（两千多MHz）
    2. 内存条的频率 最大到三千兆赫兹（3000MHz）
5. PCI SATA这些是什么
